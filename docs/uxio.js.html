<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>uxio.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-files-FileSaveError.html">FileSaveError</a></li></ul><h3>Modules</h3><ul><li><a href="module-files.html">files</a><ul class='methods'><li data-type='method'><a href="module-files.html#.save">save</a></li><li data-type='method'><a href="module-files.html#.send">send</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#Uxio">Uxio</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">uxio.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// src/uxio.js

const busboy = require("busboy");
const path = require("path");
const os = require("os");
const fs = require("fs");
const files = require("./files");

/**
 * @typedef {object} UxioFile
 * @property {string} fieldname - The name of the form field.
 * @property {string} filename - The original name of the file.
 * @property {string} encoding - The encoding of the file.
 * @property {string} mimeType - The MIME type of the file.
 * @property {string} tempFilePath - The full path to the temporary file on the disk.
 * @property {number} size - The size of the file in bytes.
 */

/**
 * @typedef {object} UxioObject
 * @property {function(): boolean} hasFile - Checks if any file was uploaded in the request.
 *
 * @property {function} hasFiles - Checks if files with specific field names exist.
 * @param {string|string[]} fieldNames - The name(s) of the file field(s) to check for.
 * @returns {boolean} True if any of the specified file fields exist, otherwise false.
 *
 * @property {UxioFile[]} files - An array of objects, each representing an uploaded file.
 * @property {function(): void} cleanup - Manually cleans up the temporary cache directory.
 */

/**
 * Express/Connect-compatible middleware for handling multipart/form-data uploads.
 * This middleware parses uploaded files and form fields, making them available on
 * `req.uxio` and `req.body` objects.
 *
 * It automatically cleans up temporary files once the response is finished or closed.
 *
 * @param {Object} [options] - Optional configuration for the middleware.
 * @returns {Function} Express/Connect-compatible middleware function.
 */
function Uxio(options = {}) {
  /**
   * @param {object} req - The Express/Connect request object.
   * @param {object} res - The Express/Connect response object.
   * @param {function} next - The next middleware function.
   * @prop {UxioObject} req.uxio - The custom object added to the request.
   */
  return (req, res, next) => {
    if (
      req.method === "POST" &amp;&amp;
      req.headers["content-type"] &amp;&amp;
      req.headers["content-type"].startsWith("multipart/form-data")
    ) {
      const requestId = Date.now().toString(36) + Math.random().toString(36).substring(2);

      const tempCacheDir = path.join(os.tmpdir(), `.uxio-cache-${requestId}`);
      fs.mkdirSync(tempCacheDir, { recursive: true });

      req.uxio = {
        get hasFile() {
          return this.files.length > 0;
        },
        hasFiles: (fieldNames) => {
          if (Array.isArray(fieldNames)) {
            return this.files.some((file) => fieldNames.includes(file.fieldname));
          } else if (typeof fieldNames === "string") {
            return this.files.some((file) => file.fieldname === fieldNames);
          }
          return false;
        },
        files: [],
        cleanup: () => {
          if (fs.existsSync(tempCacheDir)) {
            fs.rmSync(tempCacheDir, { recursive: true, force: true });
            console.log(`Cleaned up temp directory: ${tempCacheDir}`);
          }
        },
      };

      res.on("finish", () => {
        req.uxio.cleanup();
      });
      res.on("close", () => {
        req.uxio.cleanup();
      });

      const bb = busboy({ headers: req.headers });

      bb.on("file", (fieldname, file, info) => {
        const { filename, encoding, mimeType } = info;
        const tempFilePath = path.join(
          tempCacheDir,
          `${fieldname}-${filename}`,
        );
        const writeStream = fs.createWriteStream(tempFilePath);
        req.uxio.files.push({
          fieldname,
          filename,
          encoding,
          mimeType,
          tempFilePath,
          size: 0,
        });

        file.on("data", (data) => {
          const fileObj = req.uxio.files.find((f) => f.fieldname === fieldname);
          if (fileObj) {
            fileObj.size += data.length;
          }
        });
        file.pipe(writeStream);
      });

      bb.on("field", (fieldname, val, info) => {
        req.body = req.body || {};
        req.body[fieldname] = val;
      });

      bb.on("close", () => {
        next();
      });

      req.pipe(bb);
    } else {
      next();
    }
  };
};

module.exports = Object.assign(Uxio, { files });
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Fri Aug 15 2025 05:26:37 GMT+0300 (East Africa Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
